# æ–‡å­—åˆ—

## ä»•æ§˜ã«ã¤ã„ã¦

Dè¨€èªã®æ–‡å­—åˆ—ã¯æ–‡å­—ã®é…åˆ—ã§ã‚ã‚‹ã€‚æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¯immutableã§ã‚ã‚‹ã€‚

```d
char[] str1 = "abc";                // error: æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¯æš—é»™ã«mutableãªchar[]ã¸ã¨å¤‰æ›ã§ããªã„ã€‚
char[] str2 = "abc".dup;            // ok: dupã‚’ä½¿ãˆã°mutableãªã‚³ãƒ”ãƒ¼ãŒå¯èƒ½ã€‚
immutable(char)[] str3 = "abc";     // ok
immutable(char)[] str4 = str2;      // error: mutableãªchar[]ã‹ã‚‰immutableã¸ã¯æš—é»™å¤‰æ›ã§ããªã„ã€‚
immutable(char)[] str5 = str3;      // ok: immutableãªchar[]ã¯ä»£å…¥ã§ãã‚‹ã€‚
immutable(char)[] str6 = str2.idup; // ok: idupã‚’ä½¿ãˆã°immutable ãªã‚³ãƒ”ãƒ¼ãŒã§ãã‚‹ã€‚
```

å®Ÿéš›ã«ã€stringå‹ã¯ `immutable(char)[]` ã¨ãªã£ã¦ã„ã‚‹ã€‚ä¸Šã®å‡¦ç†ã¨åŒç­‰ã®å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚‚æ›¸ã‘ã‚‹ã€‚

```d
char[] str1 = "abc";     // error
char[] str2 = "abc".dup; // ok
string str3 = "abc";     // ok
string str4 = str2;      // error
string str5 = str3;      // ok
string str6 = str2.idup; // ok
```

`immutable(char)[]` å‹ã¯ `immutable char` ã®é…åˆ—ã‚’è¡¨ç¾ã™ã‚‹ãŒã€æ–‡å­—åˆ—ãã‚Œè‡ªä½“ã¸ã®å‚ç…§ã¯mutableã¨ãªã‚‹ã€‚

```d
immutable char[] s = "foo"; // ã‚‚ã—ãã¯ immutable(char[])
s[0] = 'a';  // error: immutableãªãƒ‡ãƒ¼ã‚¿ã¸ã®å‚ç…§ã‚’æ›¸ãæ›ãˆã‚ˆã†ã¨ã—ã¦ã„ã‚‹
s = "bar";   // error: sã¯immutable

immutable(char)[] s = "hello";  // string
s[0] = 'b';  // error: s[]ã¯immutable
s = null;    // ok: sè‡ªä½“ã¯mutable
```

ã¾ãŸã€`char[]`ã¯UTF-8ãªæ–‡å­—åˆ—ã‚’è¡¨ã—ã€`wchar[]` ãŠã‚ˆã³ `dchar[]` ã¯ãã‚Œãã‚ŒUTF-16/UTF-32æ–‡å­—åˆ—ã¨ãªã‚‹ã€‚

æ–‡å­—åˆ—ã¯ã‚³ãƒ”ãƒ¼ãƒ»æ¯”è¼ƒãƒ»çµåˆãƒ»(æœ«å°¾ã¸ã®)è¿½åŠ ãŒå¯èƒ½ã§ã‚ã‚‹ã€‚

```d
str1 = str2;
if (str1 < str3) { ... }
func(str3 ~ str4);
str4 ~= str1;
```

ä¸€æ™‚å¤‰æ•°ã¯GC(ã‚‚ã—ãã¯ `alloca()`)ã«ã‚ˆã£ã¦è§£æ”¾ã•ã‚Œã‚‹ã€‚
ã“ã‚Œã¯æ–‡å­—åˆ—ã«é™ã‚‰ãšé…åˆ—ä¸€èˆ¬ã«é©ç”¨ã•ã‚Œã‚‹ã€‚

æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã‹ã‚‰charã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```d
char* p = &str[3];  // 4ç•ªç›®ã®è¦ç´ ã¸ã®ãƒã‚¤ãƒ³ã‚¿
char* p = str;      // å…ˆé ­ã®è¦ç´ ã¸ã®ãƒã‚¤ãƒ³ã‚¿
```

Dè¨€èªã®æ–‡å­—åˆ—ã¯Cè¨€èªã®ã‚ˆã†ã«nullçµ‚ç«¯ã«ãªã£ã¦ã„ãªã„ã€‚Cè¨€èªã®é–¢æ•°ã«æ–‡å­—åˆ—ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æ¸¡ã™éš›ã«ã€æœ«å°¾ã‚’nullçµ‚ç«¯ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```d
str ~= "\0";
```

ã‚ã‚‹ã„ã¯æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® `std.string.toStringz` é–¢æ•°ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ã€‚

### Cè¨€èªã®printfã¨æ–‡å­—åˆ—

å‰è¿°ã—ãŸã‚ˆã†ã«ã€Cè¨€èªã®é–¢æ•°ã«Dè¨€èªã®æ–‡å­—åˆ—ã‚’æ¸¡ã™å ´åˆã¯nullçµ‚ç«¯ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ã—ã‹ã—æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã«ã‹ã‚“ã—ã¦ã¯ã€ã™ã§ã«nullçµ‚ç«¯ã«ãªã£ã¦ã„ã‚‹ãŸã‚ãã®ã¾ã¾æ¸¡ã™ã“ã¨ãŒã§ãã‚‹ã€‚

```d
import core.stdc.stdio;
printf("the string literal is '%s'\n", "string literal".ptr);
```

ã“ã“ã§æœ€åˆã®å¼•æ•°ã§ `.ptr` ã‚’è¦æ±‚ã—ã¦ã„ãªã„ã®ã¯ãªãœã ã‚ã†ã‹ï¼Ÿ
æœ€åˆã®å¼•æ•°ã¯ `const(char)*` ã¨ã„ã†ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®£è¨€ãŒãªã•ã‚Œã¦ãŠã‚Šã€æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¯ `const(char)*` ã¸ã¨æš—é»™ã«ã‚­ãƒ£ã‚¹ãƒˆã•ã‚Œã‚‹ã€‚
ã—ã‹ã—printfã®æ®‹ã‚Šã®å¼•æ•°ã¯å¯å¤‰é•·ã§ã‚ã‚Šã€ `immutable(char)*` ã¯å¯å¤‰é•·å¼•æ•°ã«æ¸¡ã™ã“ã¨ãŒã§ããªã„ã€‚

ã¾ãŸåˆ¥ã®æ–¹æ³•ã¨ã—ã¦precision specifierã¨ã—ã¦æ–‡å­—åˆ—é•·ã‚’æŒ‡å®šã™ã‚‹ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚‹ã€‚

```d
printf("the string is '%.*s'\n", cast(int)str.length, str.ptr);
```

æœ€è‰¯ã®æ–¹æ³•ã¯ `std.stdio.writefln` ã‚’ä½¿ã†ã“ã¨ã§ã‚ã‚‹ã€‚

```d
import std.stdio;
writefln("the string is '%s'", str);
```

## UTF-8

æ–‡å­—åˆ—ã¯UTF-8ãªã®ã§ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚‚æ‰±ã†ã“ã¨ãŒã§ãã‚‹ã€‚
lengthãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§é•·ã•ã‚’å–å¾—ã—ãŸå ´åˆã¯ãƒã‚¤ãƒˆæ•°ãŒè¿”å´ã•ã‚Œã‚‹ã€‚

```d
string s1 = "hello";
assert(s1.length == 5);

string s2 = "ğŸ’–ğŸ’–ğŸ’–ğŸ’–ğŸ’–";
assert(s2.length == 20);
```

ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆå˜ä½ã®é•·ã•ã‚’å–ã‚ŠãŸã„å ´åˆã¯ `std.algorithm.count` ãŒåˆ©ç”¨ã§ãã‚‹ã€‚

```d
import std.algorithm : count;
assert(s2.count == 5);
```

æ–‡å­—åˆ—ã§ã¯ `s[i]` ã¯ãƒã‚¤ãƒˆã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œã™ã‚‹ã€‚

```d
assert(s1[2] == 'l');
assert(s1[0] == 104);
//assert(s2[0] == 'ğŸ’–'); // error
assert(s2[0] == 240);  // ok: ã—ã‹ã—ã»ã¨ã‚“ã©ã®é¢ã§æœ‰ç”¨ã§ã¯ãªã„
```

charã¯1ãƒã‚¤ãƒˆã—ã‹è¡¨ç¾ã§ããªã„ä¸€æ–¹ã€UTF-8ã¯ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã§ã‚ã‚‹ã€‚ãã®ãŸã‚1ãƒã‚¤ãƒˆã«ãŠã•ã¾ã‚‰ãªã„æ–‡å­—ã¯è¤‡æ•°ã®charã«ã¾ãŸãŒã£ã¦è¡¨ç¾ã•ã‚Œã‚‹ã€‚

```d
assert(s2[0..4] == "ğŸ’–"); // ok: ã²ã¨ã¤ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’4ãƒã‚¤ãƒˆã§è¡¨ç¾ã—ã¦ã„ã‚‹
string s3 = [240, 159, 146, 150];  // ã“ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã‚‚ã§ãã‚‹
assert(s3 == "ğŸ’–");  // ok
```

### auto decoding

Dè¨€èªã®æ–‡å­—åˆ—ã¯ãƒ¬ãƒ³ã‚¸ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã‚ˆã†ãªæ“ä½œã‚’è¡Œã†éš›ã«ã€æš—é»™ã«char/wchar -> dcharã¸ã®å¤‰æ›ã‚’å†…éƒ¨ã§è¡Œã£ã¦æ“ä½œã•ã‚Œã‚‹ã€‚

```d
string s1 = "hello";
assert(s1.length == 5);

char[] s2 = ['h', 'e', 'l', 'l', 'o'];
import std.algorithm;
auto size = s2.map!(c => c.sizeof).sum;  // auto decoding
assert(size == 20);
```

## å‚è€ƒè³‡æ–™

- Dè¨€èªä»•æ§˜ æ–‡å­—åˆ—: https://dlang.org/spec/arrays.html#string
- auto decoding and you: https://jackstouffer.com/blog/d_auto_decoding_and_you.html